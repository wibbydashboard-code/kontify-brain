<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontify - Mentores Estrat√©gicos | Diagn√≥stico Corporativo</title>
    <!-- Iconos de Marca (Unificados + Fallback Instant√°neo) -->
    <link rel="icon" type="image/png" href="assets/favicon.png?v=4">
    <!-- PRUEBA DE FAVICON (C√≠rculo Verde Kontify) -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23C1FF72%22/></svg>">
    <link rel="apple-touch-icon" href="assets/favicon.png?v=4">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --verde-neon: #C1FF72;
            --azul-electrico: #007BFF;
            --negro: #000000;
            --blanco: #FFFFFF;
            --gris: #1A1A1A;
            --gris-claro: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--negro);
            color: var(--blanco);
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        header {
            padding: 20px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            position: fixed;
            width: 100%;
            z-index: 1000;
            border-bottom: 1px solid #222;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-k {
            width: 32px;
            height: 32px;
            background: var(--verde-neon);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-weight: 700;
            color: #000;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .logo-slogan {
            font-size: 10px;
            text-transform: uppercase;
            color: #888;
            display: block;
            margin-top: -5px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 120px 20px 60px;
        }

        .hero {
            text-align: center;
            margin-bottom: 60px;
        }

        .hero h1 {
            font-size: 3.5rem;
            line-height: 1.1;
            margin-bottom: 20px;
        }

        .hero h1 span {
            color: var(--azul-electrico);
        }

        .hero p {
            color: #888;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .quiz-card {
            background: #0a0a0a;
            border: 1px solid #222;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 123, 255, 0.05);
            position: relative;
        }

        .step-info {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .step-label {
            color: var(--verde-neon);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: #222;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--azul-electrico), var(--verde-neon));
            width: 0%;
            transition: width 0.3s ease;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #ccc;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        select {
            width: 100%;
            padding: 15px;
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            border-color: var(--azul-electrico);
            outline: none;
        }

        .question-box {
            margin-top: 10px;
            animation: fadeIn 0.4s ease;
            transition: opacity 0.2s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }

        .option-btn {
            padding: 25px;
            background: #111;
            border: 1px solid #333;
            border-radius: 12px;
            color: #fff;
            cursor: pointer;
            font-weight: 700;
            font-size: 18px;
            transition: all 0.2s;
            text-align: center;
        }

        .option-btn:hover:not(:disabled) {
            border-color: var(--verde-neon);
            background: #1a1a1a;
            transform: scale(1.02);
        }

        .option-btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .btn-next {
            width: 100%;
            padding: 18px;
            background: var(--azul-electrico);
            color: #fff;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 40px;
            transition: all 0.2s;
        }

        .btn-next:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 123, 255, 0.3);
            filter: brightness(1.1);
        }

        footer {
            padding: 60px 5%;
            background: #050505;
            border-top: 1px solid #111;
            font-size: 12px;
            color: #555;
            text-align: center;
        }

        .legal-box {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        #loading {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(193, 255, 114, 0.1);
            border-top-color: var(--verde-neon);
            border-radius: 50%;
            animation: spin 0.8s infinite linear;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .fade-out {
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }
    </style>
</head>

<body>
    <div id="loading">
        <div class="spinner"></div>
        <p id="loading-text" style="color: var(--verde-neon); font-weight: 600; font-size: 18px;">Cargando cuestionario
            t√©cnico...</p>
    </div>

    <header>
        <div class="logo-container">
            <div class="logo-k">K</div>
            <div>
                <div class="logo-text">Kontify</div>
                <div class="logo-slogan">Mentores Estrat√©gicos</div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="hero">
            <h1>Diagn√≥stico de <span>Blindaje Corporativo</span></h1>
            <p>Acceda a su reporte de riesgos y oportunidades dise√±ado por consultores senior e inteligencia artificial.
            </p>
        </div>

        <div class="quiz-card" id="quiz-container">
            <!-- Step 1: Info Base -->
            <div id="step-1">
                <div class="step-info">
                    <span class="step-label">Fase 1: Informaci√≥n Base</span>
                    <span style="color: #444;">1 / 3</span>
                </div>
                <div class="form-group">
                    <label>Nombre de la Empresa *</label>
                    <input type="text" id="company_name" placeholder="Ej. Empresa de Construcci√≥n Pe√±a"
                        oninput="validatePhase1()">
                </div>
                <div class="form-group">
                    <label>RFC *</label>
                    <input type="text" id="rfc" placeholder="Ej. ABC123456XYZ" oninput="validatePhase1()">
                </div>
                <div class="form-group">
                    <label>Actividad Principal / Giro *</label>
                    <input type="text" id="main_activity" placeholder="Ej. Comercializaci√≥n de acero"
                        oninput="validatePhase1()">
                </div>
                <div class="form-group">
                    <label>Rango de Facturaci√≥n Anual (MXN) *</label>
                    <select id="billing_range" onchange="validatePhase1()">
                        <option value="">Seleccione un rango...</option>
                        <option value="< 10M">Menos de $10M</option>
                        <option value="10M - 50M">$10M - $50M</option>
                        <option value="50M - 100M">$50M - $100M</option>
                        <option value="+100M">M√°s de $100M</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sector / Nicho *</label>
                    <select id="niche_id" onchange="validatePhase1()">
                        <option value="holding">Holding / Grupo Familiar</option>
                        <option value="constructora">Constructora e Inmobiliaria</option>
                        <option value="autotransporte">Autotransporte de Carga</option>
                        <option value="comercializadora">Comercializadora e Importaci√≥n</option>
                        <option value="manufactura">Industria de la Transformaci√≥n</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nombre del Representante *</label>
                    <input type="text" id="contact_name" placeholder="Ej. Juan P√©rez" oninput="validatePhase1()">
                </div>
                <div class="form-group">
                    <label>Cargo del Representante *</label>
                    <input type="text" id="contact_role" placeholder="Ej. Director General" oninput="validatePhase1()">
                </div>
                <div class="form-group">
                    <label>Correo Electr√≥nico Corporativo *</label>
                    <input type="email" id="contact_email" placeholder="ejemplo@empresa.com" oninput="validatePhase1()">
                </div>
                <div class="form-group">
                    <label>Tel√©fono de Contacto</label>
                    <input type="text" id="contact_phone" placeholder="Ej. 55 1234 5678">
                </div>

                <div
                    style="background: rgba(0,123,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px dashed var(--azul-electrico);">
                    <h3
                        style="color: var(--azul-electrico); font-size: 14px; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 1px;">
                        üìä Datos Financieros (Estimados)</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Ventas Anuales</label>
                            <input type="text" id="sales_annual" placeholder="Ej. 10,000,000">
                        </div>
                        <div class="form-group">
                            <label>Utilidad Neta</label>
                            <input type="text" id="net_profit" placeholder="Ej. 2,000,000">
                        </div>
                        <div class="form-group">
                            <label>Total Activos</label>
                            <input type="text" id="total_assets" placeholder="Ej. 50,000,000">
                        </div>
                        <div class="form-group">
                            <label>Total Pasivos</label>
                            <input type="text" id="total_liabilities" placeholder="Ej. 30,000,000">
                        </div>
                    </div>
                </div>
                <button class="btn-next" id="btn-start" onclick="startQuiz()" disabled
                    style="opacity: 0.5; cursor: not-allowed;">Comenzar Diagn√≥stico T√©cnico</button>
            </div>

            <!-- Step 2: Quiz Din√°mico -->
            <div id="step-2" style="display: none;">
                <div class="step-info">
                    <span class="step-label" id="category-label">Categor√≠a</span>
                    <span style="color: #444;" id="progress-text">0 / 66</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar-fill"></div>
                </div>
                <div class="question-box" id="q-box">
                    <h2 id="current-question"
                        style="font-size: 22px; font-weight: 600; min-height: 100px; line-height: 1.4;">Cargando...</h2>
                    <div class="options">
                        <button class="option-btn" id="btn-si" onclick="answer('S√≠')">S√ç</button>
                        <button class="option-btn" id="btn-no" onclick="answer('No')">NO</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: √âxito -->
            <div id="step-3" style="display: none; text-align: center; padding: 40px 0;">
                <div
                    style="width: 80px; height: 80px; background: var(--verde-neon); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 30px; box-shadow: 0 0 20px rgba(193,255,114,0.4);">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <h1 style="font-size: 32px; margin-bottom: 20px;">¬°An√°lisis Completo!</h1>
                <p style="color: #888; margin-bottom: 30px; font-size: 18px;">Su diagn√≥stico ha sido procesado. Los
                    resultados han sido enviados a su CRM y el reporte PDF est√° listo.</p>
                <div id="btn-report-container"></div>
                <a href="/" class="btn-next"
                    style="display: inline-block; background: transparent; border: 2px solid #333; margin-top: 15px; text-decoration: none;">Realizar
                    otro diagn√≥stico</a>
            </div>
        </div>
    </div>

    <footer>
        <div class="legal-box">
            <p
                style="margin-bottom: 20px; color: #888; font-weight: 700; text-transform: uppercase; font-size: 11px; letter-spacing: 1px;">
                Aviso Legal Kontify - Mentores Estrat√©gicos</p>
            <p><strong>Privacidad:</strong> Kontify trata sus datos con estricta confidencialidad bajo la LFPDPPP. La
                informaci√≥n es utilizada √∫nicamente para el an√°lisis estrat√©gico solicitado.</p>
            <p style="margin-top: 30px; border-top: 1px solid #111; padding-top: 20px; color: #333;">&copy; 2026 Kontify
                | Consultor√≠a Estrat√©gica con Inteligencia Artificial</p>
        </div>
    </footer>

    <script>
        // CONFIGURACI√ìN DEL MOTOR (Brain)
        // Cambia esto a la URL de Render/Vercel cuando est√© desplegado
        const API_BASE_URL = window.location.hostname === 'localhost' ? '' : 'https://kontify-brain.onrender.com';

        let currentStep = 0;
        let responses = [];
        let questions = [];

        function validatePhase1() {
            const company = document.getElementById('company_name')?.value;
            const rfc = document.getElementById('rfc')?.value;
            const activity = document.getElementById('main_activity')?.value;
            const billing = document.getElementById('billing_range')?.value;
            const name = document.getElementById('contact_name')?.value;
            const role = document.getElementById('contact_role')?.value;
            const email = document.getElementById('contact_email')?.value;
            const btn = document.getElementById('btn-start');

            if (company && rfc && activity && billing && name && role && email) {
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            } else {
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
            }
        }

        async function startQuiz() {
            const company_name = document.getElementById('company_name').value.trim();
            const contact_name = document.getElementById('contact_name').value.trim();
            const contact_role = document.getElementById('contact_role').value.trim();
            const contact_email = document.getElementById('contact_email').value.trim();
            const contact_phone = document.getElementById('contact_phone').value.trim();
            const niche = document.getElementById('niche_id').value;
            const billing_range = document.getElementById('billing_range').value;
            const rfc = document.getElementById('rfc').value.trim();
            const main_activity = document.getElementById('main_activity').value.trim();

            if (!company_name || !contact_name || !contact_email || !rfc || !main_activity || !billing_range) {
                alert("Por favor complete todos los campos obligatorios (*) y aseg√∫rese de que no est√©n vac√≠os.");
                return;
            }

            // Guardar metadatos extendidos globalmente
            window.leadMetadata = {
                company_name,
                contact_name,
                contact_role,
                contact_email,
                contact_phone,
                niche_id: niche,
                billing_range,
                rfc,
                main_activity,
                financial_data: {
                    sales: document.getElementById('sales_annual').value.trim(),
                    profit: document.getElementById('net_profit').value.trim(),
                    assets: document.getElementById('total_assets').value.trim(),
                    liabilities: document.getElementById('total_liabilities').value.trim()
                }
            };

            // Mostrar Loading
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');
            loadingText.innerText = "Cargando cuestionario t√©cnico para " + niche.toUpperCase() + "...";
            loading.style.display = 'flex';

            try {
                const res = await fetch(`${API_BASE_URL}/api/questions/${niche}`);
                questions = await res.json();

                if (questions.error) throw new Error(questions.error);

                loading.style.display = 'none';
                document.getElementById('step-1').style.display = 'none';
                document.getElementById('step-2').style.display = 'block';
                showQuestion();
            } catch (e) {
                alert("Error al conectar con el servidor: " + e.message);
                loading.style.display = 'none';
            }
        }

        function showQuestion() {
            if (currentStep >= questions.length) {
                submitFinal();
                return;
            }

            const qBox = document.getElementById('q-box');
            qBox.classList.add('fade-out');

            setTimeout(() => {
                const q = questions[currentStep];
                document.getElementById('current-question').innerText = q.q;
                document.getElementById('category-label').innerText = "Categor√≠a: " + q.cat;
                document.getElementById('progress-text').innerText = (currentStep + 1) + " / " + questions.length;

                const progress = ((currentStep + 1) / questions.length) * 100;
                document.getElementById('progress-bar-fill').style.width = progress + '%';

                // Dinamismo de botones (Limpiar y reconstruir)
                const optionsContainer = document.querySelector('.options');
                optionsContainer.innerHTML = '';

                if (q.options && q.options.length > 0) {
                    if (q.options.length > 2) {
                        // REGLA: Opciones > 2 -> Renderizar Dropdown
                        optionsContainer.style.gridTemplateColumns = '1fr';
                        const select = document.createElement('select');
                        select.className = 'option-btn';
                        select.style.appearance = 'auto';
                        select.style.textAlign = 'left';
                        select.style.paddingLeft = '15px';
                        select.style.cursor = 'pointer';

                        const defaultOpt = document.createElement('option');
                        defaultOpt.text = "--- SELECCIONE UNA OPCI√ìN ---";
                        defaultOpt.value = "";
                        defaultOpt.disabled = true;
                        defaultOpt.selected = true;
                        select.appendChild(defaultOpt);

                        q.options.forEach(opt => {
                            const o = document.createElement('option');
                            o.value = opt;
                            o.text = opt.toUpperCase();
                            select.appendChild(o);
                        });

                        select.onchange = () => {
                            if (select.value) {
                                // Peque√±o delay visual
                                setTimeout(() => answer(select.value), 200);
                            }
                        };
                        optionsContainer.appendChild(select);
                    } else if (q.options.length === 2) {
                        // REGLA: Opciones == 2 -> Botones S√ç/NO (o los que vengan)
                        optionsContainer.style.gridTemplateColumns = '1fr 1fr';
                        q.options.forEach(opt => {
                            const btn = document.createElement('button');
                            btn.className = 'option-btn';
                            btn.innerText = opt.toUpperCase();
                            btn.onclick = () => answer(opt);
                            optionsContainer.appendChild(btn);
                        });
                    } else {
                        // Fallback (1 opci√≥n)
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.innerText = q.options[0].toUpperCase();
                        btn.onclick = () => answer(q.options[0]);
                        optionsContainer.appendChild(btn);
                    }
                } else {
                    // Fallback a S√ç/NO tradicional
                    optionsContainer.style.gridTemplateColumns = '1fr 1fr';
                    const btnSi = document.createElement('button');
                    btnSi.className = 'option-btn';
                    btnSi.innerText = 'S√ç';
                    btnSi.onclick = () => answer('S√≠');

                    const btnNo = document.createElement('button');
                    btnNo.className = 'option-btn';
                    btnNo.innerText = 'NO';
                    btnNo.onclick = () => answer('No');

                    optionsContainer.appendChild(btnSi);
                    optionsContainer.appendChild(btnNo);
                }

                qBox.classList.remove('fade-out');
            }, 250);
        }

        function answer(val) {
            // Bloqueo para evitar doble clic
            const btns = document.querySelectorAll('.option-btn');
            btns.forEach(b => b.disabled = true);

            const q = questions[currentStep];
            responses.push({
                q_index: currentStep + 1,
                category_id: q.cat,
                question: q.q,
                answer: val
            });

            currentStep++;
            showQuestion();
        }

        // PERSISTENCIA DE DATOS (Auto-recuperaci√≥n)
        function saveProgress() {
            const progress = {
                leadMetadata: window.leadMetadata,
                responses: responses,
                currentStep: currentStep,
                niche: document.getElementById('niche_id').value
            };
            localStorage.setItem('kontify_progress', JSON.stringify(progress));
        }

        function loadProgress() {
            const saved = localStorage.getItem('kontify_progress');
            if (saved) {
                const data = JSON.parse(saved);
                // Si el usuario quiere recuperar, podr√≠amos preguntar, pero por ahora solo lo guardamos
                console.log("Progreso recuperable disponible:", data);
            }
        }

        async function submitFinal() {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');
            loadingText.innerText = "KONTIFY PILOT: Procesando 66 vectores de riesgo...";
            loading.style.display = 'flex';

            const payload = {
                lead_metadata: window.leadMetadata,
                responses: responses,
                timestamp: new Date().toISOString()
            };

            try {
                const res = await fetch(`${API_BASE_URL}/api/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();
                loading.style.display = 'none';

                if (result.status === "success") {
                    localStorage.removeItem('kontify_progress');
                    document.getElementById('step-2').style.display = 'none';
                    document.getElementById('step-3').style.display = 'block';

                    const container = document.getElementById('btn-report-container');
                    const pdfUrl = result.report_url.startsWith('http') ? result.report_url : `${API_BASE_URL}${result.report_url}`;

                    container.innerHTML = `
                        <a href="${pdfUrl}" target="_blank" class="btn-next" style="display: block; text-decoration: none; text-align: center; margin-bottom: 20px;">
                            üì• Descargar Diagn√≥stico T√©cnico (PDF)
                        </a>
                        <p style="font-size: 12px; color: #444; border: 1px dashed #ccc; padding: 10px; border-radius: 8px;">
                            <strong>Folio Garantizado:</strong> ${result.requestId}<br>
                            Los resultados han sido sincronizados con su consultor asignado.
                        </p>
                    `;
                } else {
                    const errorMsg = result.message || "Error en el motor de an√°lisis.";
                    alert(`‚ö†Ô∏è AVISO DE SISTEMA:\n${errorMsg}\n\nFolio: ${result.requestId || 'N/A'}\nPor favor, intente de nuevo o contacte a soporte si el problema persiste.`);
                }
            } catch (e) {
                loading.style.display = 'none';
                alert("‚ö†Ô∏è FALLO DE CONEXI√ìN:\nNo pudimos establecer comunicaci√≥n con el servidor central. Por favor, verifique su internet e intente enviar sus respuestas de nuevo.");
            }
        }

        // Llamar a guardar despu√©s de cada respuesta
        const originalAnswer = answer;
        answer = function (val) {
            originalAnswer(val);
            saveProgress();
        };

        // VERSI√ìN: 2.1.1 - BUILD: 20260206_HARD_RESET
        console.log("üöÄ KONTIFY DIAGNOSTIC ENGINE v2.1.1 (HARD-RESET) READY");
        window.onload = () => {
            console.log("üõ†Ô∏è Sincronizando SOPs y L√≥gica de Dropdowns...");
            loadProgress();
            console.log("üõ†Ô∏è Metadata captured:", window.leadMetadata);
        };
    </script>
</body>

</html>